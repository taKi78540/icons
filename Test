#"Personnalisée ajoutée5" =
    Table.AddColumn(
        #"Liste des comptoirs développée",
        "createdAt_local",
        each
            let
                dt = DateTime.From([createdAt]),     // UTC
                d  = Date.From(dt),
                y  = Date.Year(d),

                // Helpers
                LastSunday = (yy as number, mm as number) as date =>
                    let
                        lastDay = Date.EndOfMonth(#date(yy, mm, 1)),
                        offset  = Date.DayOfWeek(lastDay, Day.Sunday)
                    in
                        Date.AddDays(lastDay, -offset),

                NthSunday = (yy as number, mm as number, n as number) as date =>
                    let
                        firstDay = #date(yy, mm, 1),
                        firstSundayOffset = Number.Mod(7 - Date.DayOfWeek(firstDay, Day.Sunday), 7),
                        firstSunday = Date.AddDays(firstDay, firstSundayOffset)
                    in
                        Date.AddDays(firstSunday, 7 * (n - 1)),

                // EU DST: last Sunday of March -> last Sunday of October
                euStart = LastSunday(y, 3),
                euEnd   = LastSunday(y, 10),
                isDstEU = d >= euStart and d < euEnd,

                // NA DST: 2nd Sunday of March -> 1st Sunday of November
                naStart = NthSunday(y, 3, 2),
                naEnd   = NthSunday(y, 11, 1),
                isDstNA = d >= naStart and d < naEnd,

                rule = Text.Upper(Text.From([Liste des comptoirs.DST Rule])),
                isDst =
                    if rule = "EU" then isDstEU
                    else if rule = "NA" then isDstNA
                    else false,

                baseOffset = [Liste des comptoirs.UTC_number],
                dstAdd = if [Liste des comptoirs.DST Delta] = 1 and isDst then 1 else 0,
                offsetReal = baseOffset + dstAdd
            in
                dt + #duration(0, offsetReal, 0, 0),
        type datetime
    ),
