TendanceAttente_Compare =
VAR MoisSel = SELECTEDVALUE('TableDate'[YearMonth])
VAR AnneeSel = YEAR(MoisSel)
VAR MoisSelNum = MONTH(MoisSel)
VAR MoisCourant = AnneeSel * 100 + MoisSelNum

VAR MoisAvecEtat =
    ADDCOLUMNS(
        SUMMARIZE(
            CALCULATETABLE(
                'lecomptoir allvisits_181124',
                REMOVEFILTERS('TableDate')
            ),
            YEAR('lecomptoir allvisits_181124'[CreatedAt]),
            MONTH('lecomptoir allvisits_181124'[CreatedAt])
        ),
        "Ordre", 
            YEAR('lecomptoir allvisits_181124'[CreatedAt]) * 100 
            + MONTH('lecomptoir allvisits_181124'[CreatedAt]),
        "Etat",
            VAR an = YEAR('lecomptoir allvisits_181124'[CreatedAt])
            VAR mois = MONTH('lecomptoir allvisits_181124'[CreatedAt])
            VAR pct =
                DIVIDE(
                    CALCULATE(
                        COUNTROWS('lecomptoir allvisits_181124'),
                        'lecomptoir allvisits_181124'[waitingTime (minA)] > 10,
                        YEAR('lecomptoir allvisits_181124'[CreatedAt]) = an,
                        MONTH('lecomptoir allvisits_181124'[CreatedAt]) = mois
                    ),
                    CALCULATE(
                        COUNTROWS('lecomptoir allvisits_181124'),
                        YEAR('lecomptoir allvisits_181124'[CreatedAt]) = an,
                        MONTH('lecomptoir allvisits_181124'[CreatedAt]) = mois
                    )
                )
            RETURN IF(pct <= 0.15, "positive", "poor")
    )

VAR MoisPrecedents =
    FILTER(MoisAvecEtat, [Ordre] < MoisCourant)

VAR EtatInitial =
    MAXX(TOPN(1, MoisPrecedents, [Ordre], DESC), [Etat])

VAR MoisConsecutifs =
    COUNTROWS(
        TOPN(
            COUNTROWS(MoisPrecedents),
            FILTER(
                ADDCOLUMNS(
                    MoisPrecedents,
                    "Break", IF([Etat] = EtatInitial, 0, 1)
                ),
                VAR Rupture =
                    COUNTROWS(
                        FILTER(
                            MoisPrecedents,
                            [Ordre] >= EARLIER([Ordre]) && [Etat] <> EtatInitial
                        )
                    )
                RETURN Rupture = 0
            ),
            [Ordre], DESC
        )
    )

RETURN
    IF(
        EtatInitial = "positive",
        "Positive for " & MoisConsecutifs & " month" & IF(MoisConsecutifs > 1, "s", ""),
        "Poor for " & MoisConsecutifs & " month" & IF(MoisConsecutifs > 1, "s", "")
    )
