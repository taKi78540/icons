TendanceAttente_test2 =
VAR MoisSel = SELECTEDVALUE('TableDate'[YearMonth])
VAR AnneeSel = YEAR(MoisSel)
VAR MoisSelNum = MONTH(MoisSel)
VAR MoisCourant = AnneeSel * 100 + MoisSelNum

-- Neutraliser le slicer TableDate
VAR DonneesSansFiltreDate =
    CALCULATETABLE(
        'lecomptoir allvisits_181124',
        REMOVEFILTERS('TableDate')
    )

-- Liste des mois
VAR Mois =
    ADDCOLUMNS(
        SUMMARIZE(
            DonneesSansFiltreDate,
            'lecomptoir allvisits_181124'[CreatedAt],
            'lecomptoir allvisits_181124'[comptoir]
        ),
        "Annee", YEAR('lecomptoir allvisits_181124'[CreatedAt]),
        "Mois", MONTH('lecomptoir allvisits_181124'[CreatedAt]),
        "Ordre", YEAR('lecomptoir allvisits_181124'[CreatedAt]) * 100 + MONTH('lecomptoir allvisits_181124'[CreatedAt])
    )

-- Ajout de l'état (positive / poor)
VAR MoisAvecEtat =
    ADDCOLUMNS(
        SUMMARIZE(Mois, [Annee], [Mois], [Ordre], [comptoir]),
        "Etat",
        VAR an = [Annee]
        VAR mois = [Mois]
        VAR comptoir = [comptoir]
        VAR nb_sup10 =
            CALCULATE(
                COUNTROWS('lecomptoir allvisits_181124'),
                'lecomptoir allvisits_181124'[waitingTime (minA)] > 10,
                YEAR('lecomptoir allvisits_181124'[CreatedAt]) = an,
                MONTH('lecomptoir allvisits_181124'[CreatedAt]) = mois,
                'lecomptoir allvisits_181124'[comptoir] = comptoir
            )
        VAR total =
            CALCULATE(
                COUNTROWS('lecomptoir allvisits_181124'),
                YEAR('lecomptoir allvisits_181124'[CreatedAt]) = an,
                MONTH('lecomptoir allvisits_181124'[CreatedAt]) = mois,
                'lecomptoir allvisits_181124'[comptoir] = comptoir
            )
        VAR pct = DIVIDE(nb_sup10, total)
        RETURN IF(pct < 0.15, "positive", "poor")
    )

-- On prend uniquement les mois avant le mois sélectionné
VAR MoisRecents =
    FILTER(MoisAvecEtat, [Ordre] < MoisCourant)

-- État du mois le plus récent
VAR EtatInitial =
    MAXX(
        TOPN(1, MoisRecents, [Ordre], DESC),
        [Etat]
    )

-- Compte des mois consécutifs avec le même état
VAR MoisConsecutifs =
    COUNTROWS(
        TOPN(
            COUNTROWS(MoisRecents),
            FILTER(
                ADDCOLUMNS(
                    MoisRecents,
                    "Break", IF([Etat] = EtatInitial, 0, 1)
                ),
                VAR Cumul =
                    COUNTROWS(
                        FILTER(
                            MoisRecents,
                            [Ordre] >= EARLIER([Ordre]) &&
                            [Etat] <> EtatInitial
                        )
                    )
                RETURN Cumul = 0
            ),
            [Ordre], DESC
        )
    )

RETURN
    SWITCH(
        EtatInitial,
        "positive", "Positive for " & MoisConsecutifs & " months",
        "poor", "Poor for " & MoisConsecutifs & " months",
        BLANK()
    )
