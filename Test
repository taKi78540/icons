TendanceAttente_Compare =
VAR MoisSel =
    SELECTEDVALUE('TableDate'[YearMonth])
VAR AnneeSel =
    YEAR(MoisSel)
VAR MoisSelNum =
    MONTH(MoisSel)
VAR MoisCourant =
    AnneeSel * 100 + MoisSelNum

-- Liste des mois avec calcul état (positive/mauvaise)
VAR MoisAvecEtat =
    ADDCOLUMNS(
        SUMMARIZE(
            CALCULATETABLE(
                'lecomptoir allvisits_181124',
                REMOVEFILTERS('TableDate')
            ),
            "Annee", YEAR('lecomptoir allvisits_181124'[CreatedAt]),
            "Mois", MONTH('lecomptoir allvisits_181124'[CreatedAt])
        ),
        "Ordre", [Annee] * 100 + [Mois],
        "Etat",
            VAR an = [Annee]
            VAR mois = [Mois]
            VAR nb_sup10 =
                CALCULATE(
                    COUNTROWS('lecomptoir allvisits_181124'),
                    'lecomptoir allvisits_181124'[waitingTime (minA)] > 10,
                    YEAR('lecomptoir allvisits_181124'[CreatedAt]) = an,
                    MONTH('lecomptoir allvisits_181124'[CreatedAt]) = mois
                )
            VAR total =
                CALCULATE(
                    COUNTROWS('lecomptoir allvisits_181124'),
                    YEAR('lecomptoir allvisits_181124'[CreatedAt]) = an,
                    MONTH('lecomptoir allvisits_181124'[CreatedAt]) = mois
                )
            VAR pct = DIVIDE(nb_sup10, total)
            RETURN IF(pct <= 0.15, "positive", "poor")
    )

-- Garder seulement les mois avant le mois sélectionné (non inclus)
VAR MoisPrecedents =
    FILTER(MoisAvecEtat, [Ordre] < MoisCourant)

-- État initial (dernier mois précédent sélectionné)
VAR EtatInitial =
    MAXX(
        TOPN(1, MoisPrecedents, [Ordre], DESC),
        [Etat]
    )

-- Nombre de mois consécutifs avec même état
VAR MoisConsecutifs =
    COUNTROWS(
        TOPN(
            1000,
            FILTER(
                ADDCOLUMNS(
                    MoisPrecedents,
                    "Break", IF([Etat] = EtatInitial, 0, 1)
                ),
                [Break] = 0
            ),
            [Ordre], DESC
        )
    )

-- Résultat
RETURN
    SWITCH(
        EtatInitial,
        "positive", "Positive for " & MoisConsecutifs & " months",
        "poor", "Poor for " & MoisConsecutifs & " months",
        BLANK()
    )
